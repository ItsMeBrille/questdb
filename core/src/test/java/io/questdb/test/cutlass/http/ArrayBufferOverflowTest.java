/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2024 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.test.cutlass.http;

import io.questdb.cairo.DefaultCairoConfiguration;
import io.questdb.cairo.arr.ArrayState;
import io.questdb.cairo.arr.ArrayTypeDriver;
import io.questdb.cairo.arr.DirectArrayView;
import io.questdb.cairo.arr.NoopArrayState;
import io.questdb.std.MemoryTag;
import io.questdb.std.Unsafe;
import io.questdb.std.str.CharSink;
import io.questdb.std.str.StringSink;
import io.questdb.std.str.Utf16Sink;
import io.questdb.test.AbstractTest;
import io.questdb.test.tools.TestUtils;
import org.junit.AfterClass;
import org.junit.Ignore;
import org.junit.Test;

import java.util.Arrays;

public class ArrayBufferOverflowTest extends AbstractTest {
    private static final TestHttpClient testHttpClient = new TestHttpClient();

    @AfterClass
    public static void tearDownStatic() {
        testHttpClient.close();
        AbstractTest.tearDownStatic();
        assert Unsafe.getMemUsedByTag(MemoryTag.NATIVE_HTTP_CONN) == 0;
    }

    @Test
    public void testArrayToTextContinuity() {
        try (DirectArrayView arrayView = new DirectArrayView(new DefaultCairoConfiguration(root))) {
            var rnd = TestUtils.generateRandom(LOG);
            rnd.nextDoubleArray(2, arrayView, 1, 10, 0);
            var sinkActual = new StringSink();
            var sinkExpected = new StringSink();
            // we do not split values yet, such as double, so the sink should be
            // large enough for at least 1 value.
            var chunkSize = Math.max(31, rnd.nextInt(10000));
            var sinkInterrupted = new Utf16Sink() {
                private boolean bufOut = true;

                @Override
                public Utf16Sink put(char c) {
                    if (sinkActual.length() > 0 && (sinkActual.length() % chunkSize) == 0) {
                        if (bufOut) {
                            // interrupt the sinking on each chunk
                            // when we reach the chunk, we expect code retry to climb over
                            // this chunk, but fail on the next one
                            bufOut = false;
                            throw new RuntimeException("buf out");
                        } else {
                            bufOut = true;
                        }
                    }
                    return sinkActual.put(c);
                }
            };

            var statePrototype = new ArrayState() {
                final int[] contender = new int[STATE_MAX];
                final int[] target = new int[STATE_MAX];
                int flatIndex;
                int sinkLen = 0;

                @Override
                public boolean notRecorded(int flatIndex) {
                    return this.flatIndex <= flatIndex;
                }

                @Override
                public void putAsciiIfNotRecorded(int eventType, int eventDelta, CharSink<?> sink, char symbol) {
                    if ((contender[eventType] += eventDelta) > target[eventType]) {
                        sink.put(symbol);
                        this.sinkLen = sinkActual.length();
                        target[eventType] = contender[eventType];
                    }
                }

                @Override
                public void record(int flatIndex) {
                    this.sinkLen = sinkActual.length();
                    this.flatIndex = flatIndex;
                }
            };

            while (true) {
                try {
                    ArrayTypeDriver.arrayToJson(
                            arrayView,
                            sinkInterrupted,
                            ArrayTypeDriver::appendDoubleFromArrayToSink,
                            statePrototype
                    );
                    break;
                } catch (Throwable e) {
                    sinkActual.trimTo(statePrototype.sinkLen);
                    Arrays.fill(statePrototype.contender, 0);
                }
            }

            ArrayTypeDriver.arrayToJson(
                    arrayView,
                    sinkExpected,
                    ArrayTypeDriver::appendDoubleFromArrayToSink,
                    NoopArrayState.INSTANCE
            );

            TestUtils.assertEquals(sinkExpected, sinkActual);
        }
    }

    @Test
    @Ignore
    public void testSimple() throws Exception {
        TestUtils.assertMemoryLeak(() -> {
            HttpServerConfigurationBuilder httpServerConfigurationBuilder = new HttpServerConfigurationBuilder();
            httpServerConfigurationBuilder.withSendBufferSize(1024);
            new HttpQueryTestBuilder()
                    .withTempFolder(root)
                    .withWorkerCount(1)
                    .withHttpServerConfigBuilder(httpServerConfigurationBuilder)
                    .withTelemetry(false).run((engine, sqlExecutionContext) -> testHttpClient.assertGet(
                            "{\"query\":\"select rnd_double_array(5, 1, 0, 4, 5, 4, 4, 4);\",\"columns\":[{\"name\":\"rnd_double_array\",\"type\":\"ARRAY\",\"dim\":5,\"elemType\":\"DOUBLE\"}],\"timestamp\":-1,\"dataset\":[[[[[[[null,0.3760950281748988,0.8842040190766682,null],[0.723911438524962,null,0.8867906519052142,0.6024066825135606],[null,0.7559721706726428,null,null],[0.9612474357709804,0.9809341700243055,0.9657577302253819,null]],[[null,0.9529003432871073,0.47737531254674437,null],[0.450801977245773,0.18402410666570534,0.6212673737547589,0.6333410318331486],[null,null,0.711449867617936,0.8988122127523825],[0.32577029695394477,null,0.5132844642955225,0.43480865293419046]],[[0.8891790451688182,null,0.44892079294908227,null],[0.27045420940188736,null,null,0.6796067157292756],[null,null,0.7743635717363533,null],[null,0.49295686337175104,0.3015748837839386,0.6930056717067804]],[[null,null,0.2384302330321103,0.9841070615327345],[0.1916255351432854,null,0.31398487179013956,null],[null,null,null,null],[0.598501296504007,null,0.530663366863691,0.19903557645208114]]],[[[0.021812692089295482,null,null,0.8987418298844135],[0.4506983037032328,null,0.18245816243172364,null],[0.9561860231571433,null,null,null],[0.8587237755520356,null,null,null]],[[0.5407313838846879,null,0.5648104825480595,0.354173454363073],[0.7132195022619391,0.5177336786935577,0.30489549851431585,null],[null,0.6470232169012033,0.908815171612566,0.2677591919936574],[0.30800925046853533,0.03474459062145596,0.2558652243365116,0.47661149327289964]],[[0.3689711754645334,0.42636185400212245,0.37699319106422,0.7981724228258694],[null,0.7164834955198403,0.3820277223777595,null],[null,null,null,null],[0.5417221390035449,0.8668981490016553,null,null]],[[null,0.7073716318035194,0.24896660965097694,0.9799004477797298],[0.7169142937148066,null,0.22867078299444965,0.7753982196328867],[0.19989261544610837,null,null,null],[null,null,0.9440200193199385,null]]],[[[0.3949662140691256,0.010064619722633839,null,null],[null,0.5506547222362088,0.7558969991818428,null],[0.6116677640161796,null,0.9571242535628135,null],[0.4112627355677947,0.06116459746497105,null,null]],[[null,0.8167134178172647,null,null],[null,0.3337359136416216,0.09489295677130416,0.2683839129867702],[null,0.700323402134848,null,0.22803218733962938],[null,null,null,null]],[[0.512166833667833,0.06348229633130031,0.483992604186654,null],[null,null,null,null],[0.86626654529074,0.3654875502407383,0.20129734516169018,null],[0.5104435138201705,null,0.7525486616709759,null]],[[null,0.05674912263734033,null,0.20969687275464133],[null,null,0.8142547961013089,null],[null,0.572908729734957,0.08061184196732674,null],[null,null,0.2808571968963859,0.3400797696704341]]],[[[0.8510726808854571,0.9808038234545685,0.08739772978626403,0.3646921217312654],[null,null,null,null],[null,null,0.5479476458524796,null],[null,0.6957163994170095,0.035119959346577856,null]],[[null,0.17450539652878283,0.4154111471035531,null],[null,null,null,null],[0.6540189828040758,null,0.904852964045222,0.1548216331145883],[null,null,null,null]],[[null,0.03549807264690685,0.3342780950519604,null],[null,0.8954436806038115,null,null],[null,0.21478316597766378,0.48320001403819945,null],[null,0.41354032550274256,null,null]],[[null,null,null,0.8892578275780181],[null,null,0.32944846302379016,0.5942609904491797],[0.941917996142589,0.10211767281812001,null,null],[null,null,null,0.6478695442765822]]],[[[0.9691916700818247,null,null,0.7424782259827398],[null,null,null,0.1799710059670564],[null,0.6700939414673421,0.3764794341197357,0.16125464554160618],[0.22606528976965612,0.3953562097533979,null,0.24821429358708536]],[[0.3444563371714051,0.5660267696415691,0.591100707192032,0.39429363364357906],[0.3138146161454235,0.805684325541013,null,0.18423059500067263],[null,0.12470701651479721,null,null],[0.7535606294822513,0.8558630366028439,0.5306271479332922,0.27837891856556596]],[[null,0.029312217761164328,0.821438720370492,null],[0.06846812154023552,0.7417742940722153,null,null],[null,null,0.09087574580281366,0.7419752175157989],[0.29954361732468027,0.6743098758590385,null,null]],[[null,0.5401509320422317,null,null],[null,0.5942171467480304,0.6657500774094433,null],[null,0.7760320353199958,null,0.939480348197922],[null,null,0.6635877855893254,0.9128608638664163]]]],[[[[null,null,null,null],[0.3749443768169658,0.3955567083189042,null,null],[0.2606485826880829,null,0.6762446158981132,0.2566039475087193],[null,null,null,null]],[[0.963922866310367,0.7168661549886746,0.5213926573257288,0.22101086143167503],[null,0.30720061158699086,null,null],[null,0.2057584512844819,null,null],[0.6890328185726329,0.6808904973650697,null,0.3058778589479866]],[[null,0.3520086050793897,null,null],[0.8055657925853622,0.2790429422741729,0.6881579425703378,null],[null,null,null,0.7765100594016662],[0.571131433412184,null,0.7492028373362423,0.8615165999821459]],[[null,0.7075858132677983,0.817506754167545,0.40963594685588867],[null,0.8313801598606777,null,null],[0.05975253104515066,null,null,null],[null,0.6960017240679635,0.1500150715650237,0.5736649998004025]]],[[[null,0.7225327801501653,0.5083968963723767,0.3062272274402029],[null,0.955138649659313,null,null],[0.06500278686260241,null,null,null],[0.29112814689775934,0.05888798485680036,null,null]],[[null,0.25833730534407673,null,0.15811125738460952],[0.9972173071344435,null,null,null],[null,null,null,0.6986122909897529],[0.8695241635918478,null,0.8071217908548481,null]],[[0.6767991440806871,0.153144109171364,null,0.49956414318505815],[null,0.2016443389380531,null,0.6613752381713245],[0.5815394979214619,0.7836220990838517,0.08161240062955577,null],[0.36314509090259295,0.20651329489600978,0.032141159031202404,0.45728342849262815]],[[null,null,0.6916331507563599,0.1603627607531275],[null,0.2502695297257328,null,null],[null,0.4722314141368037,0.65369941530607,null],[null,null,0.0983298948090855,null]]],[[[null,0.7383672701735104,0.2558303700288652,null],[0.591643631764273,0.3200605885686052,0.40813006955651665,null],[null,0.10097138491245528,null,null],[null,0.7723101813525036,0.12939752238405589,0.30293767479344547]],[[0.39459258860522894,null,null,0.03354929932901185],[null,null,0.2844096397436615,null],[0.6072929262056523,null,null,0.5915596472574359],[0.5058995631886241,0.35744575317160465,0.8192211226395562,null]],[[0.7164760201484124,null,null,null],[0.31566061697938774,0.6730173872031988,null,null],[0.1142406457894175,null,0.28126374198563875,0.8873598026234523],[null,0.028713230425825187,null,0.05050523621809322]],[[null,0.8743835194787473,null,null],[null,null,0.09257466342496623,0.07486683191723043],[0.5012257995361334,null,null,0.7888570026048273],[0.5639033094015766,0.9630437247280882,null,null]]],[[[null,null,0.6671149800840014,0.5701193826985911],[0.4996740307694475,null,0.6715115843796265,null],[null,0.474695716682039,null,null],[0.7885606527362884,null,0.7026891159997427,0.10536760761747599]],[[0.34952405913987905,0.8652253070986863,null,null],[0.8368875090593482,0.5177577473883683,0.4139506530917102,null],[null,0.1370367614066763,null,0.002237180339511813],[null,0.8017435718788429,null,null]],[[null,null,0.8649509374161553,null],[null,null,null,0.4833235597384745],[0.28635887459038434,0.5242851081809382,null,null],[null,null,null,null]],[[0.6893604160978106,0.2709675306212789,0.639104603053848,0.061943109076057046],[0.6914935512281825,0.7085287787030172,0.30867846636252605,null],[0.029434835538426074,null,null,0.2514276805136433],[0.15913246614558585,null,null,0.9911644313436023]]],[[[null,null,null,null],[null,null,null,0.7470911095444136],[0.7910045808580052,0.8892860708753422,null,null],[null,null,null,null]],[[null,0.6497676003917261,null,0.3954291841321378],[0.44162629239148843,0.7076513012805914,null,null],[null,null,null,null],[0.1219773433464102,null,null,0.3618177570283849]],[[null,0.6378001943327306,0.47996023324346104,null],[0.8425507393062525,0.8257041128045084,0.7295451854511888,0.3022010234662518],[null,0.537498757721547,null,null],[null,null,0.26755595515725317,0.616330592192347]],[[null,0.39960131728994364,null,null],[0.6802371349110166,null,null,null],[0.0055408339132405615,null,null,null],[null,null,0.7264045481619702,null]]]],[[[[0.13198212626325145,0.6741636438983761,0.1310321698328767,null],[null,null,0.9018254106085847,null],[null,0.22551858355701193,0.1756892849175501,0.02338433881913593],[0.6710906717803705,null,0.427228646888978,0.7071007597659758]],[[null,null,0.5561874704611525,null],[0.06049736482009116,0.7530004579411175,null,null],[0.5673915563041025,null,0.3694229127511621,null],[null,null,null,0.006750774714025298]],[[null,null,0.17114438408994548,null],[0.3968060914052295,null,0.6784128931916371,null],[null,0.20298523016023318,0.8805727980746288,null],[0.7595981031420664,0.6780043171477168,null,0.278381953871368]],[[null,0.2966777058546629,0.9202982444832075,null],[null,0.2883397268034795,null,0.11455587090538855],[0.232279711376999,0.18107582258752075,0.1893109323390375,null],[0.40884356267014277,null,null,0.3346112106334326]]],[[[0.17398019565216083,0.6249394342934524,null,0.22608543444667972],[null,null,null,null],[null,null,0.8643884104310295,0.06131956287935991],[0.5096368694347762,null,null,null]],[[0.31825708672198205,null,null,0.593646674363313],[0.30606820378787314,0.7690946256711806,null,null],[null,null,null,null],[null,null,null,null]],[[0.532628814646848,0.42893323009321294,null,0.8630430429806869],[0.3246299298923345,null,null,0.6350532983580843],[0.6014198418971044,0.11617679324797547,null,null],[0.07299490398275721,null,0.7243489238370013,null]],[[0.6024749354001776,0.2507445755965241,null,null],[0.8712805284160482,null,0.8309115142319649,null],[0.9504208038748632,null,0.7181501318105198,0.31892928238616713],[null,null,0.43149364667625234,0.8553298717028696]]],[[[0.7940821852460384,null,0.05755114376258652,null],[0.4812867651430849,null,0.24747109298119208,null],[0.5046835487717366,null,null,0.9920852599205563],[null,null,0.2340670598140785,null]],[[null,0.7961188747173282,0.1075874201957947,null],[0.42697820870371783,null,0.23523635294898348,null],[null,null,0.16207164720846,0.2990930984620157],[0.26137049235146426,null,null,null]],[[0.3248401654718306,null,null,0.585159211009441],[0.8659329593688186,null,0.3439311910210914,null],[null,0.09950338704405315,0.6443090002292978,0.9964086066850597],[0.3379062489911562,null,0.8678055820198587,0.45281683845953435]],[[null,0.30846636136464933,0.9983994749903468,0.38371256940137244],[null,0.9910578301075359,null,null],[null,null,0.9800696001779581,null],[null,null,0.6878787817380572,null]]],[[[null,0.5388352754083552,null,null],[0.41383874018675293,null,null,0.8143451065154389],[null,0.8260396495230823,null,0.269006933025457],[0.32434972841925847,0.5449398818565625,0.4892748079063375,null]],[[0.03228929365320621,null,0.4180571562924439,0.8241499762585569],[0.3028856733356535,null,0.03110659796049764,0.7356148000522408],[0.9322365051412246,null,null,0.32683606856559744],[null,null,0.0177290762127561,0.3169419140796914]],[[null,null,0.7986282789771302,0.845170086178233],[0.2937253537658653,0.42257346495251624,0.9127027810293764,null],[0.476066615478841,0.8915534682408185,null,0.5616765638186959],[null,null,null,null]],[[0.9321023758624253,0.21777488070063555,0.2976502153749111,0.6005110826802418],[null,0.8131000255157024,0.8157486255486475,null],[0.4889528790646325,null,null,null],[null,0.17422237291035525,null,0.5794509747710263]]],[[[null,0.668522320158367,null,null],[0.9817309927489204,null,null,null],[0.6676366762119839,null,0.6584106531336028,0.6963136233060382],[0.026549133697347127,null,0.42312536473395845,0.8429968731681041]],[[null,0.7671808144776243,null,0.38779268236254927],[null,0.01905502582899743,0.3260084506518255,null],[null,null,0.5151584093746051,null],[null,0.9308310554097475,null,null]],[[0.877591229145142,null,0.34349384547134354,null],[0.25293994943385434,0.37365603525712854,0.8527935126223507,null],[null,null,0.7414442432203296,0.23378379341508304],[null,null,0.6518870070381049,null]],[[0.005083725217916446,0.1963881161178449,null,0.827996620995481],[null,null,0.7744193958775698,0.5911341046230548],[0.7683999912661296,0.7688916452159075,null,null],[null,null,null,null]]]],[[[[0.9036147708725009,null,0.2541777422760635,0.03267868314439004],[null,0.49629393148432954,null,0.09857528779122382],[null,null,0.4739980446197488,null],[null,0.8105328200248485,0.7242531094173665,0.21363185449706812]],[[null,null,0.5519854534538267,null],[null,null,null,null],[null,0.7969603124420017,0.06323871947137716,0.43696461400909226],[null,0.498585043412339,null,0.30657373064293936]],[[0.19057713200346638,0.6410596887052413,null,null],[0.7846629525506812,null,null,0.9625146005570712],[0.15148985816144356,null,0.14165458103819506,null],[null,null,null,null]],[[null,0.259973225978935,0.6033591834625174,0.7250949148115237],[null,null,0.4851776694499481,0.4527701655242684],[null,null,null,null],[null,null,null,0.9105759996432436]]],[[[null,0.07532042322261989,null,0.1459566386476555],[null,0.4943315302468515,null,null],[0.06957965908256769,null,null,null],[0.11501630277958941,null,null,null]],[[null,0.9900773830605027,0.018684328929811422,null],[0.7541823007727263,0.28694742482952285,0.41148125992334794,null],[0.264312481939742,null,0.7552479910953793,0.9114521313144004],[0.920329476257657,0.07415683724917954,0.24948895036031127,0.44201803437907106]],[[null,null,null,null],[null,0.6444577629369348,0.25902344470911787,null],[null,null,0.7244688511506112,null],[0.7862787095038418,null,null,0.8580049440281282]],[[null,null,0.25039733672485287,null],[0.9320292444090943,0.5499852327975634,0.18080201847210942,null],[0.8124519290402304,0.5962732774608557,0.9684966977735435,0.5317447578876277],[null,0.8554019819518089,0.5933337010385197,null]]],[[[null,null,0.6649555454068796,0.7337538843801578],[0.866546794266777,0.12444584104132383,null,null],[0.7518727751164813,0.23474267865265996,null,null],[0.36636940195064394,null,null,0.4328720188830818]],[[null,null,null,null],[0.05026728155554805,null,null,null],[null,0.25378670258447167,null,null],[0.9998204111552828,null,null,null]],[[null,0.49423460719313606,0.5496949122613684,null],[null,null,0.22918357073235418,0.8545076201586981],[0.937599739822127,null,null,0.4918182344840655],[null,0.35836438717854124,0.6009570192246776,null]],[[0.5536305130502699,0.4100361346129623,null,0.9247333160727483],[0.308919735762879,null,0.09149238241374147,null],[null,null,0.2359322413326017,0.9848959983641872],[null,0.9980602440631612,null,null]]],[[[null,null,null,0.52555419762818],[0.21249967076833676,null,0.24953591624669214,null],[null,0.34986401235819864,0.30660970547381594,null],[null,0.23551009669205025,0.7173180422693808,0.3808893261908697]],[[null,null,0.8043909229120693,null],[0.7174231611732437,null,null,0.030239489838357225],[0.336134773872954,0.6615790542683216,null,null],[null,null,null,null]],[[null,null,null,null],[null,0.9537846461932072,null,null],[null,null,0.45980449177002636,0.7977970770284714],[0.6050693307559305,null,0.4408771604148911,0.04791240018571874]],[[null,null,0.8672888211725563,0.9916472598619762],[0.39539326754054305,null,0.7723532311806689,null],[null,null,0.9197379070773044,null],[null,null,0.9886059799403865,0.9726817141318097]]],[[[0.0687826820200369,0.01609588850470567,null,0.5858496835196627],[0.2472382816367742,0.7801086640552897,0.3635833910138162,null],[0.19826844613559025,0.7581640805177617,null,0.8540135658447474],[0.43911830364753335,null,0.39616933779191543,null]],[[0.5119150457974692,null,0.5116428723240648,0.38832844176038694],[null,null,null,0.9934995914739763],[0.9073492086749197,null,null,0.7833772454180638],[0.5847839357143714,0.0032881204835966127,null,0.1521978256266906]],[[0.8038021345381335,null,0.4841600666402439,null],[null,null,0.9870020575503617,null],[null,0.32796596924453525,0.2661571192930394,0.7413387410392679],[null,0.5921164069263637,0.181231801883184,null]],[[null,0.42099542746318863,null,0.3896784445641637],[0.5478643789569544,0.2914128088099647,0.7843068034037721,0.4396740333098106],[0.6381472197376253,0.2412253994881992,0.7182950384092986,0.839192521800027],[0.18126495895037853,null,null,0.5632043860970444]]]]]]],\"count\":1}",
                            "select rnd_double_array(5, 1, 0, 4, 5, 4, 4, 4);"
                    ));
        });
    }
}
